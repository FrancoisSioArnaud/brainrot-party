# 03 — WS Protocol (Contrat messages) — v4

---

## 0) Règles générales

### Transport
WebSocket uniquement. Enveloppe :
- `type: string`
- `payload: object`

### Identité
- Play : `device_id`
- Master : `master_key` (secret)

### Autorité
- Serveur : claims, votes, scores, état du round (items + status)
- Master : animations Reveal (sous-étapes locales, non pilotées par le serveur)

---

## 1) Messages Lobby (inchangés)

- `JOIN_ROOM`
- `REQUEST_SYNC`
- `TAKE_PLAYER` / `RELEASE_PLAYER`
- `RENAME_PLAYER` / `UPDATE_AVATAR`
- `TOGGLE_PLAYER`
- `RESET_CLAIMS`
- `ADD_PLAYER` / `DELETE_PLAYER`
- `START_GAME`

---

## 2) Messages Game

### 2.1 `START_GAME` (Master → Serveur)
Démarre la partie.

Le serveur fige :
- `players_in_game` = players actifs et non disabled
- `senders_in_game` = snapshot setup/lobby
- couleurs assignées et persistées

Push :
- `GAME_START` à tous

---

### 2.2 `OPEN_ITEM` (Master → Serveur)
Ouvre un reel **pending** et démarre immédiatement un vote.

Payload :
- `{ round_id, item_id }`

Effets (serveur) :
- `round_active.phase=voting`
- `active_item_id=item_id`
- snapshot expected voters = `players_in_game`

Push :
- `START_VOTE { round_id, item_id, k }` aux Plays

Notes :
- Si l’item est déjà `voted`, le serveur ignore (no-op). Le Master peut quand même rouvrir l’URL en local.

---

### 2.3 `SUBMIT_VOTE` (Play → Serveur)
Payload :
- `{ round_id, item_id, selections: SenderId[] }`

Règles :
- `selections` dédupliquées
- `0..K` sélections possibles
- Si `len(selections) > K` : **tronquer** à K (politique actée)

Réponses :
- `VOTE_ACK { accepted, reason? }`
- `PLAYER_VOTED { player_id }` au Master

Le serveur clôt le vote automatiquement :
- si tous les expected voters ont voté
- ou à l’échéance d’un force close (voir ci-dessous)

---

### 2.4 `FORCE_CLOSE_VOTE` (Master → Serveur)
Force la fermeture dans 10 secondes.

Payload :
- `{ round_id, item_id }`

Push :
- `VOTE_FORCE_CLOSE_STARTED { ends_at_ms }` (au minimum Plays + Master)

---

### 2.5 `VOTE_RESULTS` (Serveur → Master)
Une fois le vote clos, le serveur calcule :
- vrais senders
- résultats par player
- points gagnés
- scores globaux mis à jour

Le reveal (animations) est ensuite joué localement côté Master.

---

### 2.6 `ITEM_VOTED` (Serveur → Tous)
Annonce que l’item est désormais `voted` et fournit les vrais senders.

Payload :
- `{ round_id, item_id, true_senders }`

Usage :
- resync léger
- cohérence de la grille Master en cas de reconnect

---

### 2.7 `ROUND_SCORE_MODAL` (Serveur → Tous)
Envoyé quand tous les items du round sont `voted`.

Payload :
- `{ round_id, ranking, scores, game_over }`

- `game_over=true` signifie : aucun round restant (fin de game), mais l’UI reste une modale score.

---

### 2.8 `START_NEXT_ROUND` (Master → Serveur)
Déclenché depuis la modale score.

Payload : `{}`

Effets :
- init round suivant si existe, sinon `phase=game_over`.

---

## 3) Resync / Close

### 3.1 `STATE_SYNC` (Client → Serveur)
Réponse : `STATE_SYNC_RESPONSE`

Toujours inclus :
- `phase`
- `players_visible`, `senders_visible`
- `scores`
- `my_player_id`
- `game` (si phase=game)

Inclus seulement si master_key valide :
- `players_all`, `senders_all`
- `game.last_vote_results` (si dispo)

---

### 3.2 `ROOM_CLOSED` (Master → Serveur)
Push : `ROOM_CLOSED_BROADCAST`
