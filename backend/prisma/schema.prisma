generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Room {
  id                 String   @id @default(cuid())
  roomCode           String   @unique
  seed               String
  status             String   // IN_GAME | GAME_END
  phase              String   // ROUND_INIT | OPEN_REEL | VOTING | TIMER_RUNNING | REVEAL_SEQUENCE | etc
  currentRoundIndex  Int
  currentItemIndex   Int
  timerEndAt         DateTime?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  senders            Sender[]
  players            Player[]
  reelItems          ReelItem[]
  rounds             Round[]
  votes              Vote[]
}

model Sender {
  id        String  @id @default(cuid())
  roomId    String
  room      Room    @relation(fields: [roomId], references: [id])
  name      String
  photoUrl  String?
  color     String
  active    Boolean @default(true)

  reelLinks ReelItemSender[]
  links     PlayerSenderLink[]
  truths    RoundItemTruth[]
  votes     Vote[]
}

model Player {
  id        String  @id @default(cuid())
  roomId    String
  room      Room    @relation(fields: [roomId], references: [id])
  name      String
  photoUrl  String?
  active    Boolean @default(true)
  score     Int     @default(0)

  link      PlayerSenderLink?
  votes     Vote[]
}

model PlayerSenderLink {
  id        String  @id @default(cuid())
  roomId    String
  room      Room    @relation(fields: [roomId], references: [id])
  playerId  String  @unique
  player    Player  @relation(fields: [playerId], references: [id])
  senderId  String?
  sender    Sender? @relation(fields: [senderId], references: [id])
}

model ReelItem {
  id      String @id @default(cuid())
  roomId  String
  room    Room   @relation(fields: [roomId], references: [id])
  url     String

  senders ReelItemSender[]
  items   RoundItem[]
}

model ReelItemSender {
  id        String  @id @default(cuid())
  reelItemId String
  reelItem  ReelItem @relation(fields: [reelItemId], references: [id])
  senderId  String
  sender    Sender  @relation(fields: [senderId], references: [id])

  @@unique([reelItemId, senderId])
}

model Round {
  id      String @id @default(cuid())
  roomId  String
  room    Room   @relation(fields: [roomId], references: [id])
  index   Int

  items   RoundItem[]
}

model RoundItem {
  id         String   @id @default(cuid())
  roundId    String
  round      Round    @relation(fields: [roundId], references: [id])
  reelItemId String
  reelItem   ReelItem @relation(fields: [reelItemId], references: [id])
  orderIndex Int
  k          Int
  opened     Boolean  @default(false)
  resolved   Boolean  @default(false)

  truths     RoundItemTruth[]
  votes      Vote[]
}

model RoundItemTruth {
  id         String   @id @default(cuid())
  roundItemId String
  roundItem  RoundItem @relation(fields: [roundItemId], references: [id])
  senderId   String
  sender     Sender    @relation(fields: [senderId], references: [id])

  @@unique([roundItemId, senderId])
}

model Vote {
  id         String   @id @default(cuid())
  roomId     String
  room       Room     @relation(fields: [roomId], references: [id])
  roundItemId String
  roundItem  RoundItem @relation(fields: [roundItemId], references: [id])
  playerId   String
  player     Player   @relation(fields: [playerId], references: [id])
  senderId   String
  sender     Sender   @relation(fields: [senderId], references: [id])
  createdAt  DateTime @default(now())

  @@index([roomId, roundItemId, playerId])
}
