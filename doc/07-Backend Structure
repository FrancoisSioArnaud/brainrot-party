
# 07 — Backend Structure (from scratch) — v3

Mise à jour :
- Avatar = base64 stocké en Redis (Option A)
- **Crop obligatoire 300x300**
- Image redimensionnée côté client avant envoi
- Le serveur valide taille minimale et peut refuser si > limite

TTL room : 12h (43200s)

---

## 1) Arborescence

```

backend/
package.json
tsconfig.json
src/
index.ts
config.ts
ws/
wsServer.ts
router.ts
messages.ts
validators.ts
auth.ts
errors.ts
broadcast.ts
redis/
redis.ts
keys.ts
ttl.ts
lua/
takePlayer.lua
roomRepo.ts
domain/
room.ts
lobby.ts
game.ts
sync.ts
close.ts
utils/
hash.ts
ids.ts
time.ts
json.ts

````

---

## 2) Règles Avatar (fixées)

### 2.1 Format attendu

- Format : `data:image/jpeg;base64,...`
- Dimension obligatoire : **300x300**
- Format final : JPEG
- Taille max recommandée : 150KB (à valider côté serveur)

### 2.2 Responsabilité

**Client (obligatoire) :**
- Capture caméra
- Crop carré
- Resize exact 300x300
- Compression JPEG (~0.7 qualité)
- Envoi base64 final

**Serveur :**
- Vérifie :
  - préfixe `data:image/`
  - taille base64 < limite (ex 200KB)
- Refuse sinon (`ERROR bad_request`)
- Ne fait PAS de traitement image (MVP)
- Stocke directement dans `players[].avatar_url`

---

## 3) Redis impact

Dans `players` JSON :

```json
{
  "player_id": "p12",
  "sender_id": "s12",
  "is_sender_bound": true,
  "active": true,
  "name": "Camille",
  "avatar_url": "data:image/jpeg;base64,/9j/4AAQSk..."
}
````

⚠ Impact mémoire :

* 300x300 JPEG ~ 40–120 KB
* 8 joueurs → ~800 KB max par room
* TTL 12h → acceptable en MVP

---

## 4) Domain Update — lobby.ts

### updateAvatar()

Flow :

1. Vérifier claim
2. Vérifier taille base64 (max 200KB)
3. Vérifier prefix MIME
4. Mettre à jour `players[].avatar_url`
5. `setPlayersAll(code, players)`
6. Broadcast `PLAYER_UPDATE`

Pas de stockage fichier.
Pas d’upload HTTP séparé.
Pas de sharp.

---

## 5) WS Messages impact

Aucun changement dans protocole.
`avatar_url` reste string.

---

## 6) Validation ajoutée (validators.ts)

Pour `UPDATE_AVATAR` :

* `typeof image === string`
* `image.startsWith("data:image/")`
* `image.length < MAX_AVATAR_LENGTH`

Sinon :

```
ERROR {
  error: "bad_request",
  message: "invalid_avatar"
}
```


